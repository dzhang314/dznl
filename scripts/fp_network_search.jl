using Base.Threads
using Random


################################################################################


@inline function two_sum(a::T, b::T) where {T}
    s = a + b
    a_prime = s - b
    b_prime = s - a_prime
    a_err = a - a_prime
    b_err = b - b_prime
    e = a_err + b_err
    return (s, e)
end


@inline deflate_range(i::UInt16) =
    ((i << 5) + (i << 4) + (i << 2) + 0x0038) >> 6


@inline function _modify_low_bits(x::UInt64, i::UInt16)
    _one = one(UInt64)
    bit = (_one << i)
    mask = bit - _one
    value = bit - (x & _one)
    return (x & ~mask) | (value & mask)
end


@inline function _modify_high_bits(x::UInt64, j::UInt16)
    _one = one(UInt64)
    _high_bit = _one << 51
    _past_bit = _one << 52
    _full_mask = _past_bit - _one
    mask = (_full_mask >> j) << j
    value = _past_bit - ((x & _high_bit) >> 51)
    return (x & ~mask) | (value & mask)
end


function generate_test_float()
    # Generate random data for sign bit and exponent.
    r = rand(UInt16)
    exponent = r & 0x03FF
    if iszero(exponent)
        return 0.0
    end
    exponent += 0x01FF
    # Generate random data for mantissa.
    m = rand(UInt64)
    i, j = minmax(
        deflate_range(UInt16((m & 0xFC00000000000000) >> 58)),
        deflate_range(UInt16((m & 0x03F0000000000000) >> 52)))
    m &= 0x000FFFFFFFFFFFFF
    m = _modify_low_bits(m, i)
    m = _modify_high_bits(m, j)
    return reinterpret(Float64, ((UInt64(r) << 48) & 0x8000000000000000) |
                                (UInt64(exponent) << 52) | m)
end


@inline _overlapping_bits(x::T, y::T) where {T} =
    iszero(y) ? 0 : iszero(x) ? precision(T) :
    max(0, precision(T) - (exponent(x) - exponent(y)))


@inline _exponent_gap(x::T, y::T) where {T} =
    iszero(y) ? exponent(floatmax(T)) - exponent(floatmin(T)) :
    iszero(x) ? 0 : exponent(x) - exponent(y)


################################################################################


const NUM_LIMBS = parse(Int, ARGS[1])
const NUM_TERMS = NUM_LIMBS + NUM_LIMBS
const IDEAL_OVERLAP_SCORE = 0
const IDEAL_ACCURACY_SCORE = NUM_LIMBS * precision(Float64)


function renormalize!(v::AbstractVector{T}) where {T}
    @assert axes(v) == (Base.OneTo(NUM_LIMBS),)
    while true
        changed = false
        for i = 1:NUM_LIMBS-1
            @inbounds x, y = v[i], v[i+1]
            (s, e) = two_sum(x, y)
            changed |= (s != x) | (e != y)
            @inbounds v[i], v[i+1] = s, e
        end
        if !changed
            return v
        end
    end
end


function riffle!(
    v::AbstractVector{T},
    x::AbstractVector{T},
    y::AbstractVector{T},
) where {T}
    @assert axes(v) == (Base.OneTo(NUM_TERMS),)
    @assert axes(x) == (Base.OneTo(NUM_LIMBS),)
    @assert axes(y) == (Base.OneTo(NUM_LIMBS),)
    for i = 1:NUM_LIMBS
        _2i = i + i
        @inbounds v[_2i-1] = x[i]
        @inbounds v[_2i] = y[i]
    end
    return v
end


function test_sum_network!(
    v::AbstractVector{T},
    network::AbstractVector{Tuple{Int,Int}},
) where {T}
    @assert axes(v) == (Base.OneTo(NUM_TERMS),)
    for (i, j) in network
        v[i], v[j] = two_sum(v[i], v[j])
    end
    overlap_score = IDEAL_OVERLAP_SCORE
    for i = 1:NUM_LIMBS-1
        @inbounds overlap_score = max(overlap_score,
            _overlapping_bits(v[i], v[i+1]))
    end
    accuracy_score = IDEAL_ACCURACY_SCORE
    for i = 1:NUM_LIMBS
        @inbounds accuracy_score = min(accuracy_score,
            _exponent_gap(v[1], v[NUM_LIMBS+i]))
    end
    return (overlap_score, accuracy_score)
end


const EvaluationResult = Tuple{Int,Int,Vector{Float64},Vector{Float64},Int}


function evaluate_sum_network(
    network::AbstractVector{Tuple{Int,Int}},
    duration_ns::UInt64,
)
    start = time_ns()
    x = Vector{Float64}(undef, NUM_LIMBS)
    y = Vector{Float64}(undef, NUM_LIMBS)
    v = Vector{Float64}(undef, NUM_TERMS)
    v_overlap = Vector{Float64}(undef, NUM_TERMS)
    v_accuracy = Vector{Float64}(undef, NUM_TERMS)
    overlap_score = IDEAL_OVERLAP_SCORE
    accuracy_score = IDEAL_ACCURACY_SCORE
    num_tests = 0
    while true
        # Generate random (but renormalized) input data.
        for i = 1:NUM_LIMBS
            @inbounds x[i] = generate_test_float()
        end
        renormalize!(x)

        for i = 1:NUM_LIMBS
            @inbounds y[i] = generate_test_float()
        end
        renormalize!(y)

        # Combine input data and execute sum network.
        riffle!(v, x, y)
        new_overlap_score, new_accuracy_score = test_sum_network!(v, network)

        # Update scores.
        if new_overlap_score > overlap_score
            overlap_score = new_overlap_score
            riffle!(v_overlap, x, y)
        end
        if new_accuracy_score < accuracy_score
            accuracy_score = new_accuracy_score
            riffle!(v_accuracy, x, y)
        end

        # Check for termination.
        num_tests += 1
        if time_ns() >= start + duration_ns
            if overlap_score == IDEAL_OVERLAP_SCORE
                empty!(v_overlap)
            end
            if accuracy_score == IDEAL_ACCURACY_SCORE
                empty!(v_accuracy)
            end
            return (overlap_score, accuracy_score,
                v_overlap, v_accuracy, num_tests)
        end
    end
end


function parallel_evaluate_sum_network(
    network::AbstractVector{Tuple{Int,Int}},
    duration_ns::UInt64,
)
    N = nthreads()
    results = Vector{EvaluationResult}(undef, N)
    @threads for i = 1:N
        @inbounds results[i] = evaluate_sum_network(network, duration_ns)
    end
    final_overlap_score = IDEAL_OVERLAP_SCORE
    final_accuracy_score = IDEAL_ACCURACY_SCORE
    final_v_overlap = Vector{Float64}(undef, 0)
    final_v_accuracy = Vector{Float64}(undef, 0)
    final_num_tests = 0
    for (overlap_score, accuracy_score,
        v_overlap, v_accuracy, num_tests) in results
        if overlap_score > final_overlap_score
            final_overlap_score = overlap_score
            final_v_overlap = v_overlap
        end
        if accuracy_score < final_accuracy_score
            final_accuracy_score = accuracy_score
            final_v_accuracy = v_accuracy
        end
        final_num_tests += num_tests
    end
    return (final_overlap_score, final_accuracy_score,
        final_v_overlap, final_v_accuracy, final_num_tests)
end


################################################################################


const CHALLENGING_TEST_CASES = Vector{Float64}[]


@static if NUM_LIMBS == 3
    push!(CHALLENGING_TEST_CASES, [1.629628781251374e91, -1.6296287810675885e91, -1.5972297469809086e75, 8.515919654636939e-108, -1.808443957011518e-108, 4.963649333098426e-124])
    push!(CHALLENGING_TEST_CASES, [-1.8788340662190666e109, 1.8788340662190666e109, 1.2554203476681202e58, -3.064991081922128e54, 1.393796574908164e42, 1.045943996412789e-53])
    push!(CHALLENGING_TEST_CASES, [1.2731474834304872e89, -1.2731474852831607e89, 2.208558963869553e71, -1.1042794154864901e71, 5.8785571137902455e54, 3.7232746957825377e42])
    push!(CHALLENGING_TEST_CASES, [-6.044629099362922e23, 9.057996198926876e18, 6.6599556124998085e7, 3.7164506938483725e-68, 3.7252902976292815e-9, -8.043058733543795e-87])
    push!(CHALLENGING_TEST_CASES, [-7.237005564343397e76, 1.4474011154664513e76, 6.4277521770359604e60, 1.4614124343501088e48, 3.568119231764799e44, 1.0900379610352939e-106])
    push!(CHALLENGING_TEST_CASES, [4.6966167223418894e108, -4.056481918841133e31, 4.05649836169656e31, -1.307680102678528e15, 1.274110638292992e15, -7.9310680643382135e-118])
    push!(CHALLENGING_TEST_CASES, [5.114672824837757e148, -2.3816761597793007e139, 5.6728821941711866e132, -9.915839531853729e122, -1.5390722665229807e113, -4.31807507525123e-78])
    push!(CHALLENGING_TEST_CASES, [-3.417579257473456e97, 3.417579257473456e97, -2.740315569995443e48, -1.461451460654206e48, -128.000155813992, 9.012203485997568e29])
    push!(CHALLENGING_TEST_CASES, [4.975652270549052e86, -4.973232364096743e86, 6.470387200116154e68, -1.168164295765226e49, 1.1692102301628015e49, 5.438001727478393e32])
    push!(CHALLENGING_TEST_CASES, [-5.575186305169237e42, 5.575186299734057e42, 1.2089258218664287e24, 1.0330176692272402e21, 2.273736886911629e-13, -39680.00012207031])
    push!(CHALLENGING_TEST_CASES, [9.085793507215196e133, -9.085482159877968e133, -1.407375449784884e14, 5.027449728121208e117, -0.011362829412362885, 1.40737219919872e14])
    push!(CHALLENGING_TEST_CASES, [-4.230758175459146e124, -4.1315860026933285e121, -1.0043554338561496e59, 1.0043056277510576e59, -4.0884926385550756e42, -2.787252867449407e42])
    push!(CHALLENGING_TEST_CASES, [2.0619633043584615, 8.837187317607459, -1.0090569611470929e-28, 8.881784197001252e-16, 8.416123746266109e-109, 1.5641274181106416e-148])
    push!(CHALLENGING_TEST_CASES, [-1.692303271065201e125, -1.731224935169783e128, 1.4901161194371017e-8, -1.8788340662190666e109, -4.038967834731351e-28, -1.4901175404702368e-8])
    push!(CHALLENGING_TEST_CASES, [1.7816302298135238e48, -1.1696751567357093e49, -1.4298335146535839e32, 1.2980729748640246e33, 5.62949953421296e14, 0.0])
    push!(CHALLENGING_TEST_CASES, [1.6035932871253152e-49, 4.276423417586625e-49, 2.3738919364399497e-66, 3.7982270951233645e-65, 9.363352709383731e-97, 2.1084395886461046e-81])
    push!(CHALLENGING_TEST_CASES, [-1.441809325544343e132, -4.436388467655785e130, -7.418658979161747e115, 1.749800579817678e100, 3.0758213317261105e98, 2.4892061114775353e-60])
    push!(CHALLENGING_TEST_CASES, [1.6405254227102168e119, -1.2911371174955645e120, -4.776323331089391e101, -1.433436602953989e104, 7.5757972210393954e81, -2.8808963866335638e17])
    push!(CHALLENGING_TEST_CASES, [-5.849280522245844e108, 9.397031630908716e108, 5.214812099416284e92, 2.8622241562737133e76, 2.8946611037000864e76, 1.1292730802429923e-57])
    push!(CHALLENGING_TEST_CASES, [-1.0264906528942834e90, 2.559971359419376e89, -5.65391060729083e73, -6.42362371002104e60, -4.835703010645732e24, -6.97625657916761e-105])
    push!(CHALLENGING_TEST_CASES, [-1.8788340680638372e109, 1.8788340662190664e109, -1.0901176727932268e93, -1.9426688916691168e84, 4.956917650650972e-119, -2.3866696030103055e-153])
    push!(CHALLENGING_TEST_CASES, [5.545339966665601e129, -8.461300109215998e124, 6.1565628761939405e113, -1.1198723710886475e102, -1.826877359723406e47, -3.48314461535785e84])
    push!(CHALLENGING_TEST_CASES, [-6.0121628285034164e23, 1.5053892716043886e23, -3.3554431998535153e7, 5.260981167968754e6, 1.0842104442916297e-19, 0.0])
    push!(CHALLENGING_TEST_CASES, [1.8201983837829247e-12, -1.8626459582490656e-9, 9.860761315262648e-32, -2.0679515313562379e-25, -2.1800973442799446e-106, 2.2420775429408636e-44])
    push!(CHALLENGING_TEST_CASES, [7.990347297345411e146, 2.03847814635561e149, -2.37143206158435e80, -1.185711002624353e80, 2.6328072917139297e64, 1.1598971911538106e-138])
    push!(CHALLENGING_TEST_CASES, [-2.3067971876657393e77, -1.1037815517561821e71, -1.2855504354071922e61, -2.3121412621836562e47, 4.734721299166835e-78, -3.1691265005705735e29])
    push!(CHALLENGING_TEST_CASES, [1.629628781251374e91, -1.6296287810675885e91, -1.5972297469809086e75, 8.515919654636939e-108, -1.808443957011518e-108, 4.963649333098426e-124])
    push!(CHALLENGING_TEST_CASES, [-1.8788340662190666e109, 1.8788340662190666e109, 1.2554203476681202e58, -3.064991081922128e54, 1.393796574908164e42, 1.045943996412789e-53])
    push!(CHALLENGING_TEST_CASES, [1.2731474834304872e89, -1.2731474852831607e89, 2.208558963869553e71, -1.1042794154864901e71, 5.8785571137902455e54, 3.7232746957825377e42])
    push!(CHALLENGING_TEST_CASES, [-6.044629099362922e23, 9.057996198926876e18, 6.6599556124998085e7, 3.7164506938483725e-68, 3.7252902976292815e-9, -8.043058733543795e-87])
end


@static if NUM_LIMBS == 4
    push!(CHALLENGING_TEST_CASES, [2.60740173815348e92, 1.1856386237343445e80, 7.180466303111825e75, -3.982729777963583e-59, 1.2554203470773362e58, -4.6533920608790976e-82, 3.9827297152225104e-59, -4.840743531433244e-122])
    push!(CHALLENGING_TEST_CASES, [-1.6300965730460776e91, 8.150149860213128e90, 9.046256971665328e74, 9.046256971665328e74, 9.134385233317867e46, 2.2420448011710716e43, 8.351370140214986e-53, -2.1084395886461044e-81])
    push!(CHALLENGING_TEST_CASES, [-1.4098091243193727e132, 1.4140615460423192e132, 3.42045198758907e97, -6.156563468186638e113, 1.2795100238796076e-124, -6.8351578507488065e97, -5.330346032004501e-141, 6.002371238945737e-113])
    push!(CHALLENGING_TEST_CASES, [3.7460982603818587e146, -9.882476561043138e139, 5.54533938824163e129, 2.2240331338678636e6, -2.09715840040252e6, 5.1954884838778526e-11, 2.910519217575176e-11, 0.0])
    push!(CHALLENGING_TEST_CASES, [3.9402012268967635e115, -3.940200619635892e115, -1.708790392761983e97, 7.068364912032809e97, -6.705697721411498e74, 2.371424663732381e80, 5.021681388309345e58, -2.008672555321911e59])
    push!(CHALLENGING_TEST_CASES, [9.713203809085998e83, -3.978589021472216e87, -4.6768052394586235e49, -4.4171176619459603e71, 7.737117878808798e25, 4.1904174945540754e52, -966656.0, 2.658440779762629e36])
    push!(CHALLENGING_TEST_CASES, [2.894803956369491e76, -6.277130065271433e57, 3.3316453058424424e57, 1.899113535444633e-65, -7.200616739603871e-59, -6.969096276381311e-105, 4.421718300208356e-75, 3.9009616437369353e-149])
    push!(CHALLENGING_TEST_CASES, [-7.205759403792794e16, 7.205759403792794e16, 5.820766096260276e-11, -5.551115007640884e-17, -1.274473694484924e-57, -4.816030451006027e-35, -5.785381555310884e-94, -2.039157646249539e-56])
    push!(CHALLENGING_TEST_CASES, [-7.383947907457612e19, -1.4536774433724577e135, -7.320097206696609e-102, 8.411715297611556e21, 7.03780802178369e-118, -16384.0, 3.1282504634647006e-148, 7.143672053759249e-102])
    push!(CHALLENGING_TEST_CASES, [-5.871356456934595e107, 5.8713564569345824e107, 1.2433080643453586e86, -1.0226322169684416e87, -1.2413305536072804e67, -3.450875571982566e69, -5.846006549323612e48, 6.812183632481164e38])
    push!(CHALLENGING_TEST_CASES, [4.594016232147922e-41, -7.174628225245973e-43, -5.0978941156238473e-57, 7.315177984445188e-99, -7.315082927604055e-99, 7.209247886713134e-130, 1.2689706161115813e-116, -9.546676420449385e-153])
    push!(CHALLENGING_TEST_CASES, [3.4008465438436026e66, 4.7890485473652087e52, 2.7875931534671616e42, 2.3261490322376837e36, 1.4757395258960092e20, 1.4750491542279216e20, 1.512732169114349e-123, 1447.5221558213234])
    push!(CHALLENGING_TEST_CASES, [-9.62749048489057e111, 3.757668132438987e109, -1.059649818601389e96, 1.5407439555099307e-33, -3.907343222133283e-34, 2.67535739137476e-51, 1.663265569966243e-111, 3.537796094391733e-74])
    push!(CHALLENGING_TEST_CASES, [1.3177747541793895e-82, -1.3177747674492827e-82, -3.57270760341971e-102, -3.661509689913129e-99, -2.358408476143235e-118, 7.9310672978348736e-118, -1.9093544887254725e-152, -3.076315956270055e-134])
    push!(CHALLENGING_TEST_CASES, [3.3230699894622893e35, -3.323069990270759e35, -0.25000000322597765, -9.006649498927103e15, 6.344855326018305e-117, -0.4999999962747097, -2.0993362836156694e-140, -2.5626663629437974e-144])
    push!(CHALLENGING_TEST_CASES, [-4095.9540805220604, 4096.003784179687, 1.3579632210380943e-17, 4.343617515274838e-19, 7.290249037356101e-51, -2.7029528549763805e-51, 2.3866690340133696e-153, 2.6241703544974242e-141])
    push!(CHALLENGING_TEST_CASES, [2.0141292675510994e101, -2.379729989242638e102, -2.584939357482397e-26, 3.1082702275611665e85, 3.380912013261648e-105, 2.854122174397744e-26, 1.1824343905629115e-125, -7.187703506756206e-43])
    push!(CHALLENGING_TEST_CASES, [-2.0458691281264813e149, 2.045869129935086e149, 1.4196068833898572e132, -6.3315334135808e13, 7.036874277043199e13, -0.001953125, 4.464794195540173e-103, 1.0440508480818471e-53])
    push!(CHALLENGING_TEST_CASES, [3.00612135864887e110, 3.0485825686679608e141, -3.88533829273804e84, -5.072638902373798e118, -2.2621080250406084e68, -1.119872371088902e102, 6.775903646509122e-21, -6.216540453954094e85])
    push!(CHALLENGING_TEST_CASES, [7.2361773677706465e75, 3.0572809642543166e103, -1.8096229248077368e50, 2.16778323866275e86, 1.4210854713663963e-14, 8.034690220359185e59, 1.5709105735838735e-89, 2.076918743413931e34])
    push!(CHALLENGING_TEST_CASES, [3.7214140481367243e137, -3.721424579137932e137, -1.4202374329477997e121, -9.485685689215828e80, 8.834239536383586e71, 1.1980663139966985e52, 9.807971461541688e55, -6.044637440991456e23])
    push!(CHALLENGING_TEST_CASES, [1.0474530211252003e152, -1.0474849945267654e152, 3.67962104174651e135, 2.019483917367627e-28, 8.365623380835949e-28, 4.8407377512153797e-122, -4.840742486895404e-122, 6.816308122525147e-139])
    push!(CHALLENGING_TEST_CASES, [3.94020061963942e115, 3.0782817138236284e113, -1.2941078400771516e69, -2.668108727156437e94, -4.789048565205903e52, 1.9414610998048995e69, -1.2219745453945813e-150, -4.789048565205903e52])
    push!(CHALLENGING_TEST_CASES, [-3.1289624326910287e93, 1.4688900661297099e85, -2.315841784746324e77, -3.109050328531672e57, 3.138550867660557e57, -2.5353011733028512e30, -1.7422101014686736e41, 7.048117285025758e-119])
    push!(CHALLENGING_TEST_CASES, [-9.485687384929881e80, -6.312667548635025e82, -64.1727109361618, -1.0531229166855719e65, 1.428264838077833e-15, 1.407407620096e14, 0.0, 0.015625])
    push!(CHALLENGING_TEST_CASES, [8.750367235972984e99, 1.9073495420815933e-6, -9.80796738840647e55, -1.0587911840678754e-22, -2.8664944693454825e-6, 4.5719108103361645e-100, -1.0587911840678754e-22, 2.1149685484219044e-140])
    push!(CHALLENGING_TEST_CASES, [2.4866161818996714e86, -2.4878303501073605e86, -1.3803492693581125e70, 2.695994666715064e67, -3.55437198198879e52, -1.2089258207054132e24, -7.3719563651382984e-127, 10.3046875])
    push!(CHALLENGING_TEST_CASES, [2.218136035163113e130, -2.6855398732103843e123, -5.871356456934583e107, 1.801990312055563e-12, 2.3945242826151313e52, -9.624103041345355e-29, -2.0395563327983888e-12, 2.4365416873709325e-63])
    push!(CHALLENGING_TEST_CASES, [3.3846065633582326e125, -3.757668132422754e109, -3.7576681324381327e109, -5.092589941132456e89, -4.917443338785699e-26, -4.977746382566924e73, -1.170434331176071e-97, 1.958638517130269e-149])
    push!(CHALLENGING_TEST_CASES, [1.852832892169975e78, -9.04625690426546e74, 2.0558763603738457e62, -5.397438694757068e-79, -1.663265562503184e-111, 1.548232073770901e-95, 2.8852391079396775e-129, -1.663265562503184e-111])
    push!(CHALLENGING_TEST_CASES, [-7.098034416949286e131, 7.098034416949286e131, 3.978585819112456e87, -3.978585840666521e87, -6.2266535973588006e29, -2.1567957333720512e68, -1.6705677840076755e-52, 1.143023430415786e-100])
    push!(CHALLENGING_TEST_CASES, [3.8804329972772795e53, -6.511539319100665e54, -1.0141204748699211e31, -5.954941421116423e38, -5.271115789605134e-82, 5.312235794408696e-104, 4.382422352437779e-98, -4.115887656108938e-143])
    push!(CHALLENGING_TEST_CASES, [-1.5983833411950326e147, 3.995840782887186e146, 1.7745086042373215e131, 1.198514123055437e-94, -1.0061585106409298e59, 9.855944848705085e-111, -1.1985082181239472e-94, 1.4916681480633978e-154])
    push!(CHALLENGING_TEST_CASES, [-9.677561376537905e109, 3.0232548139689947e110, 0.12499371881747834, 1.668739871813211e94, -5.7372017889923904e-89, -519.3654587289459, 3.466424071504617e-136, -2.842170943040401e-14])
    push!(CHALLENGING_TEST_CASES, [3.725290324675889e-9, -3.7252902982705508e-9, 1.1318934279576135e-72, 1.4149414368038414e-73, 3.759971319642759e-96, -1.1185034963243704e-95, -4.15816390625796e-112, -4.15816390625796e-112])
end


@static if NUM_LIMBS == 5
    push!(CHALLENGING_TEST_CASES, [2.253200662668672e136, -2.1831381089998018e136, 8.06953086902159e118, -1.613906173804318e119, 2.3302191716706767e102, -2.239785551402851e102, 1.9258130251808829e-34, 2.0971717775605566e86, 0.0, 1.4432434630583907e17])
    push!(CHALLENGING_TEST_CASES, [2.975874300788376e79, -3.72178225711531e137, -6.71088505e7, 7.547450116005583e81, 1.87267054187688e-96, 6.582018229284824e63, -3.4400408445239584e-136, 6.71088640000038e7, 0.0, 3.637978807442263e-12])
    push!(CHALLENGING_TEST_CASES, [1.3803494338308308e70, 3.834980287998837e53, -4.995533170282106e53, 4.253529586511731e37, 8.47032946993084e-22, -8.470240624459352e-22, 1.3775324150007575e-40, -1.2320674157702405e-91, -4.2414602456281187e-106, 7.291756226013958e-108])
    push!(CHALLENGING_TEST_CASES, [-1.8788342514707108e109, 1.878834067186241e109, 2.085670210269472e93, 9.522145960254669e80, -3.250998579726329e76, -5.707443784646009e45, 2.5108406702094295e60, 1.0585359611160671e-87, -9.81366784721348e22, 1.0684594629986694e-137])
    push!(CHALLENGING_TEST_CASES, [-6.42775217705279e60, 6.427752177025551e60, -1.6775603327976643e23, 4.3557514567242745e40, -1.589350399999809e7, 4.83540813053573e24, 9.022187441587448e-10, 3.07584e7, 2.7250203927389135e-107, -1.0587910474655163e-22])
    push!(CHALLENGING_TEST_CASES, [-1.0427040200973967e131, -1.7745579983393095e131, 2.3945242992588204e52, -1.970100309819724e115, -1.8014432869220348e16, -2.0940630679085763e52, 7.315556715152986e-99, -6.64613997892458e35, 8.120918187644977e-115, 1.3818713063986567e-76])
    push!(CHALLENGING_TEST_CASES, [-2.0458691299350887e149, 2.0458691299350887e149, -1.0818539922506954e126, -8.461516400520954e124, -3.1821205042362744e88, 6.674959537044066e94, -5.075594758516841e30, -6.6869931535628484e78, 7.563656085671255e-124, -2.137227598864457e62])
    push!(CHALLENGING_TEST_CASES, [5.535207621240925e90, -1.2554203470773362e58, 1.255420347077336e58, 6.9689828737295226e41, 6.872335450749429e37, -3.417797873030395e-49, -2.624811030655528e-141, 5.7955655204259545e-70, -2.1850607610938106e-157, 0.0])
    push!(CHALLENGING_TEST_CASES, [5.733746860374146e104, -5.733764589076061e104, 2.5363485057362287e88, 1.639350195823138e87, -2.415611226518899e70, 2.760698538729115e70, 3.653826567729146e47, -2.4130670848495946e53, 2.417851639229512e24, 6.489636332847019e32])
    push!(CHALLENGING_TEST_CASES, [-9.485751274119742e80, -8.54420912312522e96, -9.403959316306904e-38, 5.280701853498742e80, -1.0440485904337925e-53, 5.2656145834278593e64, -4.2273975987838866e-71, 1.8807908804875233e-37, 7.739342653837189e-121, -1.6723949549431826e-55])
    push!(CHALLENGING_TEST_CASES, [-2.239744742177804e102, 2.2397447421799044e102, 1.243308091004499e86, -3.3230699873920057e35, -1.3479879579960755e67, 1.3208512037218073e14, -2.3384026196702278e49, -1.9551592726441925e-149, -3.0431159069732557e32, 0.0])
    push!(CHALLENGING_TEST_CASES, [9.624326006404335e111, -9.627005150364314e111, -5.339967589802275e95, 1.0429624198832569e93, -2.88230870173614e17, 8.828528615227392e15, -27.0245361328125, 2.3374546742616076e-10, 4.139120809820946e-84, -5.966672584960165e-154])
    push!(CHALLENGING_TEST_CASES, [-5.467793063983167e98, 2.7340634059860693e98, -9.183408938570345e-41, 2.938735875516039e-39, 2.1506740800288106e-57, 2.54887563215134e-57, 3.988641177445769e-90, 1.1985091464393102e-94, 4.3601508761683463e-106, -2.62417683140792e-141])
    push!(CHALLENGING_TEST_CASES, [1.5031110634322903e110, 3.939224783683115e115, -1.7254365788387096e69, 3.337479743626422e94, 3.3881317848756812e-21, -1.5638380105897516e70, 1.598727351218286e-55, -3.3872981460563618e-21, 1.586213647953683e-117, 9.4039548065783e-38])
    push!(CHALLENGING_TEST_CASES, [-6.304320991423116e116, 6.304320991423116e116, -1.334991939723044e95, 1.3122273345521747e95, -5.764606608592076e17, 4.631683569492648e77, -1.5267141027437942e-5, 0.0039062469024315756, -1.194813700683199e-88, -6.01873744140622e-36])
    push!(CHALLENGING_TEST_CASES, [5.686851884435572e101, 6.999202316512379e100, 6.216540455122333e85, 1.6849712900415454e66, -2.695994551600129e67, -7.256511089995296e43, 7.208638615650304e16, 1.1805915873197456e21, -4.978082812438582e-147, -2.5886089197743947e-16])
    push!(CHALLENGING_TEST_CASES, [-1.791795793794391e103, 1.791795811391938e103, 1.4965780331120964e51, 8.639397771996051e84, 1.6615345985661538e35, -8.627182933488205e68, 8.490516753300849e17, -1.2328653389928695e52, -2.0391576462495387e-56, 1.373152405995474e35])
    push!(CHALLENGING_TEST_CASES, [-1.9239260802247326e112, 6.455647321565462e119, 1.990263027912094e87, -3.583591587484487e103, -3.3554892548736565e7, -1.3903059902383819e87, -2.382444275051728e-100, -1.065346971007056e71, 1.539122930637713e-116, 0.0])
    push!(CHALLENGING_TEST_CASES, [6.39334103105279e147, 3.84660744038216e140, -8.343357935842987e93, 1.0889035741459044e40, -1.7422450011074804e41, 0.5156095614179427, -0.23507609670465787, 2.7755575615628914e-17, 4.773340221615282e-153, 0.0])
    push!(CHALLENGING_TEST_CASES, [-1.560874583033819e144, 1.5608741073840635e144, -4.194275703946878e124, -4.454436271303259e102, 1.6880149813686926e108, -3.4966753084964295e63, 6.518515124292483e91, -3.4253944624943037e47, 9.065944203119548e74, 7.10542735760605e-15])
    push!(CHALLENGING_TEST_CASES, [-4.8777316219409795e142, -3.098840545669078e144, -6.76921312072613e125, -2.7076852468783914e126, -9.208922176047028e108, -1.3559163817733303e110, 3.373504001223201e-80, 1.2213992319870342e83, 1.0904369027770873e-106, 0.0])
    push!(CHALLENGING_TEST_CASES, [3.227812347670893e119, -3.227812347709998e119, -3.499601332686293e100, 6.8258134170045215e97, 3.1593687500567152e66, -3.722266974633921e81, 6.220213614716923e29, -1.8708068754202505e50, -1.751627951345774e-46, 7.88860934255602e-31])
    push!(CHALLENGING_TEST_CASES, [2.3763088383266453e108, 2.607406049708142e92, 2.6074060497081422e92, 8.83612103240717e71, 2.8948022194143833e76, -62.699417114257805, -4.018080680936434e59, -8.352388326638442e-53, 4.460149039706125e43, 3.952356556043762e-112])
    push!(CHALLENGING_TEST_CASES, [3.0055188449157774e110, -4.480619523622846e103, -1.4810037054399148e94, 1.9892929456391466e87, -9.263367138985296e77, -0.00024414062486499685, 0.00024266455566695615, -3.511795728492546e-96, 9.952637130336637e-21, -6.027611863624667e-116])
    push!(CHALLENGING_TEST_CASES, [1.1579214443106698e77, -2.2086141692932513e71, 1.2748981259493133e61, 1.2788362334097386e48, 2.2300745198530623e43, 1.4651097988895717e-12, -1.8189894026988211e-12, -1.5777218104420236e-30, -1.0097419586828951e-28, 7.670458519839e-93])
    push!(CHALLENGING_TEST_CASES, [1.1307819950834158e74, 3.450961002201029e69, -2.394426086428517e52, -1.5444515510758207e26, 7.738325285546692e25, 1.1054306429076505e-75, -1.0048115780252638e-28, -1.1657323831738356e-92, -3.622271850973124e-71, 0.0])
    push!(CHALLENGING_TEST_CASES, [7.563294935299195e27, -1.6747955544231813e38, 0.9999999657156876, -9.444732965739288e21, 1.9913648916828677e-59, 0.0013544559478768784, -1.6616352057378716e-78, 8.300922883092143e-20, -7.745183833305267e-121, -1.9913648869595387e-59])
    push!(CHALLENGING_TEST_CASES, [-2.854500406103367e45, -6.968982844779553e41, 3.1691265005705735e29, -2.5134510601852762e-88, -9.313225746305131e-10, 3.5638375391682348e-106, -4.747783877301617e-66, 1.2885664573081977e-130, 2.513455713865083e-88, 0.0])
    push!(CHALLENGING_TEST_CASES, [-1.0576895500643976e124, 1.0576895500643976e124, 6.929931173117471e91, -5.4620034949298944e70, 3.251685134234106e74, -7.6624777043287084e53, -1.0057001986932396e56, 1.0506201088702495e-96, 2.4178516932724533e24, 0.0])
    push!(CHALLENGING_TEST_CASES, [1.784060465957547e44, -2.3524845335200656e108, 1.9807031183828615e28, -1.607024415001107e60, 1.15343365e7, -1.78405961588245e44, 7.244543259002623e-71, 2.080480050335765e-47, 3.3112091226445884e-105, 9.797054657468773e-106])
    push!(CHALLENGING_TEST_CASES, [-3.305279841061998e122, -1.434228232531726e122, -9.173994463960286e105, 9.173994463960286e105, -1.5028886846289742e82, 1.5177100646356345e82, -3.1720555853098627e-6, -1.6793466725333004e65, 1.6016663465578105e-145, 1.305062313225065e-54])
    push!(CHALLENGING_TEST_CASES, [7.036981837759998e13, -8.722064691547283e136, -1.1920928955078125e-7, 1.8014398633066492e16, -2.365096257731188e-52, 0.12107895314693451, -3.8725919146327086e-121, -3.341060789122092e-52, 5.421371941787845e-139, 3.7092061506874214e-68])
    push!(CHALLENGING_TEST_CASES, [-3.5489935162287216e131, -3.634194487937314e134, 6.739987001044342e66, -6.74002548438479e66, -9.353610478917779e49, -5.078778330960727e24, 7.738069725585598e25, -14152.000007629395, 8.58783744e9, 3.388131789017201e-21])
    push!(CHALLENGING_TEST_CASES, [5.7646073975806765e17, 5.142198535959385e61, 3.773625186101175e-37, -4.119864450741745e31, -1.5709098705877262e-89, -32687.46875, 3.4576939895127944e-109, 5.049005316666157e-29, -4.836870797448304e-137, -5.605193857299268e-45])
    push!(CHALLENGING_TEST_CASES, [-3.5944587311301343e78, 1.8092513941929918e75, 2.0568806966218256e62, 6.339026797634413e29, -1.2676568414624958e30, 2.748846178304e12, -65535.23109368514, 6.908934847192241e-77, 2.752103907641874e-135, 0.0])
    push!(CHALLENGING_TEST_CASES, [1.2731474852090547e89, -1.2731474852090538e89, 6.58201824460978e63, -7.846377169233127e56, -7.3070301403922894e47, -2.0282409571390402e31, -9.903529759016008e27, 3.435972188772656e10, 1.048576e6, -7.04421707200411e-133])
    push!(CHALLENGING_TEST_CASES, [-1.997919068480796e146, 1.9979190722020077e146, 2.0307638534916476e129, -5.287400292721846e123, 1.539140822268818e113, -4.010414578408519e91, -4.538972451331934e96, -6.578324154913549e63, 5.789604116778492e76, -3.14182040572665e-89])
    push!(CHALLENGING_TEST_CASES, [1.119872371088902e102, -1.119872371088902e102, -1.0950317017247723e-47, -2.672764789552425e-51, 2.2108591268893281e-75, -1.4373173612827845e-67, -1.5988140219582882e-109, 3.1075177189634235e-86, -7.708477697578027e-126, -2.624297987315712e-141])
    push!(CHALLENGING_TEST_CASES, [8.343699359065106e93, -8.343699359066055e93, 7.431582628206054e72, -2.297749270802993e77, 2.3752891325002305e55, -2.2979930738644744e18, 1.0676384295660527e37, -1.8959724736674802e-65, -4.611203457904506e18, -1.890917615498299e-124])
    push!(CHALLENGING_TEST_CASES, [1.6139062067002208e119, -3.7214142683935073e137, -6.33826699946034e29, -4.131597218311484e121, 1.74176862208e11, 2.2934986159900715e105, -1.4902255429660727e-8, 6.3382529007908585e29, 1.4100605508443678e-79, 3.4395517470211137e-136])
    push!(CHALLENGING_TEST_CASES, [9.085501172039003e133, 1.3036843752327056e92, 1.5868143549375967e108, -1.6069381962927714e60, 1.443853686106713e90, 2.589024082044017e-65, 1.5889399073723206e57, -7.092027361242743e-82, 262151.0625, -4.508290340718765e-131])
    push!(CHALLENGING_TEST_CASES, [-3.0061280559400052e110, -2.7076853285694034e126, 5.214812254829795e92, -3.006134416360717e110, 5.789604289322151e76, -6.805291128600105e38, 4.744352573167939e24, 4.909093418246178e-91, -1.4630238621612795e-98, -1.663264269841079e-111])
    push!(CHALLENGING_TEST_CASES, [5.167651916970142e120, -1.9028584642215626e109, 5.7337465399745276e104, -2.9904139400688907e51, -1.2616813242912199e88, -5.9663472414617995e-64, 7.46675996138863e-115, 1.0542192916318815e-81, 0.0, -4.206182437932529e-98])
    push!(CHALLENGING_TEST_CASES, [-3.5490172084746426e131, 3.5490172084746426e131, -5.142201741628803e61, 2.429284576974249e83, -5.7078697105660185e45, 2.4523979489992625e55, -1.2994262207056167e-113, -2.722258935367508e39, -6.395599060857711e-130, -2.3283064365386942e-10])
    push!(CHALLENGING_TEST_CASES, [-3.2733905591188204e150, 3.2733905591188204e150, -5.554777809150298e129, 2.166148198531852e127, 6.108465316091429e113, -7.1671825564392955e103, 4.017345110703594e59, 7.205760155412069e16, 5.8520953561622304e-98, -4.438601656125838e-109])
    push!(CHALLENGING_TEST_CASES, [7.804835408654303e143, -1.5242912843303415e141, -4.333354084572814e127, -9.047036261297934e74, 4.8098152095208105e111, -1.915619426082361e53, 9.611635197459344e74, -8.077934706498189e-28, 9.415652603080021e58, 4.679496658301425e-104])
    push!(CHALLENGING_TEST_CASES, [2.83921376671774e132, -2.839213765951975e132, -3.757668160989871e109, 7.6957034178398e112, 1.665620745437201e93, -1.6558729340686942e96, -8.618878752283746e76, 3.210990780210097e60, 3.355443199993914e7, -7.944640476976534e43])
    push!(CHALLENGING_TEST_CASES, [8.9435233653561e133, 1.2788228194479362e148, 7.880401239278922e115, -1.4196068833898572e132, 8.748994191821766e99, -2.9356334335724477e107, 7.931068271156934e-118, 1.1857076014437533e80, -6.560425666405868e-142, -6.653104264514909e-111])
    push!(CHALLENGING_TEST_CASES, [7.339195133625597e106, -7.339195623286311e106, 3.2166896071018392e90, -3.717067629636247e90, -5.65391060729083e73, -1.6455035519921586e63, -2.283596683371215e46, 2.7440343509906046e42, -1.719776283461119e-136, 5.902958103587057e21])
    push!(CHALLENGING_TEST_CASES, [5.29395592034618e-23, -5.293955920339339e-23, 3.14970346280618e-39, -3.562363443951941e-44, 7.24415759145813e-57, 1.492375912190642e-67, 2.5286701537552626e-74, 1.1986554458869923e-94, -2.3386601005732717e-93, 3.557179279181614e-111])
    push!(CHALLENGING_TEST_CASES, [-4.1899399156682794e152, 4.189939978107062e152, 1.124223220879648e136, -2.1370788872042254e96, -5.861817992147202e116, 9.44473296573929e21, -2.52435489670761e-29, 1.5709095811779275e-89, 3.186281217687016e-58, -3.522200364589586e-133])
    push!(CHALLENGING_TEST_CASES, [4.856626884787774e83, -2.0157702679600238e103, 1.2554203470767519e58, -1.255420347077336e58, 4.596844255431879e39, -1.1387600822941682e-38, 6.917458658896904e18, -4.387454466703566e-55, 0.0, -5.714957053981818e-101])
    push!(CHALLENGING_TEST_CASES, [2.362938431428656e21, -0.12501962062967506, 14848.000000000466, -9.971271855077624e-18, -9.094947017729233e-13, 7.07366386464136e-74, 5.737720293306461e-69, -1.70961271463885e-108, -5.147557589468029e-85, -1.7024622829066828e-136])
    push!(CHALLENGING_TEST_CASES, [-1.4859194331606303e141, -1.8170244723298625e134, -1.7157759314948464e124, -3.497762440138818e115, -4.676805239561107e49, 4.642128138921756e49, 1.9342813113836266e25, 1.252545223227872e33, 41.99562215805053, -7.779186614843764e-62])
    push!(CHALLENGING_TEST_CASES, [5.8515406288924315e110, -6.613780358527311e122, -1.5255135283370026e92, 7.339195571168229e106, 7.991167942157451e70, 3.373502660766946e-80, -2.189528853382808e-47, -3.359022178366197e-139, -3.87243360165351e-121, 0.0])
    push!(CHALLENGING_TEST_CASES, [-7.992377463730087e146, 7.991677240909493e146, 6.49844459559566e128, -8.872543021186608e130, -1.8837583105867537e23, -9.353610477675215e49, -1.2582912e7, 1.5111657378497057e23, 3.1633993167430687e-117, 1.712278711498136e-132])
    push!(CHALLENGING_TEST_CASES, [-6.455624695411026e119, 6.509157748745981e119, -1.913502898859e25, -6.495259752315581e103, -7.778640185507812e8, 3.557131850588232e80, -2.9802322387695312e-8, -1.152921503769735e18, 3.248568292880268e-114, 1.1561420412958575e-125])
    push!(CHALLENGING_TEST_CASES, [-5.4153704896313755e126, -7.804371375697869e143, -5.9833877032327165e51, -4.332239323289319e127, -2.255043856007168e15, -5.197999552721829e98, 3.1724272966236427e-117, -3.0354085648908086e82, 6.4066656935381876e-145, 0.0])
end


@static if NUM_LIMBS == 6
    push!(CHALLENGING_TEST_CASES, [1.732917437529521e128, -1.73291862978695e128, 2.6691689745966633e95, -1.9239259691893597e112, 1.4231571467823894e79, -9.798143046168878e94, 1.667119228657277e60, -2.658496373173913e36, 1.78405961588245e44, 21902.410754658278, 9.223372036787667e18, 0.0])
    push!(CHALLENGING_TEST_CASES, [-7.751797098191415e137, 1.0817382296293142e124, 7.09312163563397e121, 8.507059097822472e37, -3.0247719934350374e105, -5.753044236148257e-32, -1.2731474852090538e89, -3.52160763675089e-48, -8.507059163986498e37, 7.745183829924051e-121, -1.4757395258939118e20, 4.8350962450679024e-150])
    push!(CHALLENGING_TEST_CASES, [-1.4196068845880208e132, 9.049995641606074e133, 1.034500186829447e115, 2.63993441515843e117, 9.569221922199026e98, 1.6454868784526466e63, -4.553130375829545e82, -5.764607480994299e17, 1.6849966674815763e66, 1.3177747370460897e-82, 1.1933646115599885e50, -9.454570104363225e-125])
    push!(CHALLENGING_TEST_CASES, [4.994797680505588e145, 9.75633880578274e142, 2.1655188361236195e127, -3.5297285927438082e-15, -7.515336264876266e110, -1.7486269020305817e-46, 3.552713678800345e-15, 2.2859717168293067e-100, 5.500534981794346e-32, -1.954884398615936e-117, -6.37252261219542e-58, -9.775785874907081e-150])
    push!(CHALLENGING_TEST_CASES, [1.7014121380981555e38, -1.7014118285306742e38, 6.023798688788649e21, -1.4073749484363197e14, -405606.5747211121, -2.980368107863284e-8, 1.6769696742358065e-11, 4.039385029730196e-28, -4.0783143425111076e-56, -8.758115568046213e-47, 0.0, -4.890570949489893e-91])
    push!(CHALLENGING_TEST_CASES, [4.1157055995659055e62, 2.1062451965887177e65, -8.720353641559692e40, -2.0124192467553942e48, -2.8534807239019463e19, -3.3299614493204032e31, 0.001953124999999993, 2.2512500243169305e15, -2.443523616941305e-32, -0.04619187116622913, 1.1763390659647701e-54, -8.225566729288563e-20])
    push!(CHALLENGING_TEST_CASES, [-1.135685503113004e133, 6.8351585130384336e97, -6.835210580973196e97, 2.163774324736e12, 4.980101966007732e81, -6.283638351549054e-89, -2.486918972030151e22, 1.9375307563476317e-121, 6.603576986040517e-89, 2.5672277350520906e-144, 1.3788239360251502e-105, 0.0])
    push!(CHALLENGING_TEST_CASES, [9.7133444611283e83, -2.2919726764635836e105, 1.7513373067648e13, -7.376162609940276e85, 1.5258789062444474e-5, 6.901746346790564e69, -4.235164736271502e-22, -1.7592186171056e13, 3.5373746401631547e-74, 9.536743036573334e-7, 8.200532354961315e-143, 0.0])
    push!(CHALLENGING_TEST_CASES, [-8.627709507778546e68, 8.631395430817926e68, 9.578097130411805e52, -6.886595715103189e52, 1.8889465941882917e22, 4.8184541834108915e36, -1.0620262061295653e-29, 9.223372067012474e19, -7.778783831595464e-62, 3010.7050781250005, -1.2288674869767097e-135, 1.1368640404074704e-13])
    push!(CHALLENGING_TEST_CASES, [2.094969989058822e152, -2.0949699890573415e152, 2.1657826044011002e127, 4.436271510591814e130, -3.111818922175329e110, 8.211802159551242e99, -3.213876088518345e60, -1.2046823696904838e83, -3.4392904415421963e-136, -1.4921902141290554e66, -4.661462957000129e-156, 3.7901189937628796e-152])
    push!(CHALLENGING_TEST_CASES, [-1.9979190722021871e146, 1.997919072202235e146, -3.454837146330349e128, -2.1774163379906674e40, 2.177807183186647e40, -6.951511316734668e-18, -9.503762546775161e22, -7.346839637901076e-40, -0.01562500012710188, -2.529258844452971e-60, 1.2407709188295415e-24, 5.764582166741412e-125])
    push!(CHALLENGING_TEST_CASES, [-1.524291150890936e141, -6.156563468186659e113, 4.411644604622047e124, -3.065287084339758e54, 6.999202320933483e100, -3.32306998946229e35, -7.770675568902916e84, 127.99609374999999, 3.06499161824868e54, 6.938893903907228e-17, 0.0, 4.281325671129096e-50])
    push!(CHALLENGING_TEST_CASES, [4.9732323556056927e86, -4.973232364115958e86, 3.774392597678612e68, -5.142244306692415e61, -2.114521264121274e52, 4.8356942951661575e24, -1.3292279956301734e36, 4.768405932701616e-7, 1.4580403793611978e17, 1.0097419578248668e-28, 15.999999955296516, 9.681479787123844e-122])
    push!(CHALLENGING_TEST_CASES, [1.2787664668514034e111, 1.4346512453318744e104, -8.369773419543311e94, 1.591434353558619e88, 2.894802230932905e76, -2.638030782667496e70, -1.1368684716943262e-13, 6.541361625210075e51, 6.059736966556697e-81, 5.815372481655725e35, -5.8171256162893424e-98, 2.371482538272935e19])
    push!(CHALLENGING_TEST_CASES, [6.427752177035961e60, -6.42775217775575e60, 1.7840596288857665e44, -1.6646598656155147e7, 9.903520314283042e27, -2.91038304567341e-11, -1.9999937053758003, 2.8817544617631672e-27, 1.2212227174223358e-32, 1.793662034335766e-43, -3.3409558876152446e-52, -8.043058718562431e-87])
    push!(CHALLENGING_TEST_CASES, [8.26319960990253e121, -5.164499756192568e120, -6.191934410352013e104, -4.4346945894709564e104, -5.0706011905792204e30, -3.1828687130226345e88, 1.28092970418176e14, 5.070602400912917e30, -2.188524696324225e-106, -5.304295677996289e-23, -5.017523295991906e-141, -2.3738483206106364e-66])
    push!(CHALLENGING_TEST_CASES, [-4.1136359250643663e62, -9.526820555923143e139, -1.7482403880226594e46, 4.113761650295765e62, -3.094850098213451e26, -3.875005441165575, -18.00000000008913, -5.014182869702201e-88, 1.7763568394002505e-15, 2.0020830951830536e-146, 8.21673973836835e-143, 0.0])
    push!(CHALLENGING_TEST_CASES, [5.033788364442401e145, -3.90425388176153e143, 5.502016424270992e129, 4.332296397063773e127, -1.2231041660325265e108, 5.729409934355156e-42, 1.233113412775584e-32, 7.876987550028369e-60, 1.0264251725725935e-48, 2.996272872220104e-95, 3.745341080519412e-96, 3.818674551363433e-152])
    push!(CHALLENGING_TEST_CASES, [-8.4615164004845195e124, 8.461516558121281e124, 1.6681339522014516e94, 1.833826964970597e108, -2.2912455183952106e77, -7.84258848460441e91, 4.3939712147706994e60, 8.843503409042503e-75, 1.4549358134390524e42, 5.9925457337335044e-95, -3.777908995262235e22, -2.624170757416767e-141])
    push!(CHALLENGING_TEST_CASES, [2.5218595192620364e117, 1.6074157971911792e60, 1.0595670872339982e73, 1.1146016984968724e44, -7.843264287665968e56, 4098.56401564555, 2047.9999390128064, -4.547473508864641e-13, 0.0, -2.524510893191439e-72, 0.0, 2.262556359150478e-100])
    push!(CHALLENGING_TEST_CASES, [5.931135557768168e85, -9.98961455609117e145, -3.36999333339383e66, 3.93115705830635e129, -524032.0000006278, -1.5914344513683773e88, -2.9103830456733704e-11, 3.36999333339383e66, 1.5490367695365968e-120, -0.0019531250291038305, 1.2856335400856516e-136, -4.840756087512941e-122])
    push!(CHALLENGING_TEST_CASES, [-0.00012206756922239492, 3.725345450826505e-9, -8.077965069311557e-28, 4.1128099792479864e-25, -8.968310169590737e-44, 2.215803196840037e-44, 7.348631724720649e-61, 1.089027673480809e-60, 6.693056985693053e-77, -2.0107646833843486e-87, -3.74534108378101e-96, 0.0])
    push!(CHALLENGING_TEST_CASES, [-2.528709687486035e30, -2.4758800786157965e27, 1.353191621099846e-20, -1.0737418249999995e9, -7.52316384526264e-37, -1.3607530154768765e-20, -3.186183824574464e-58, -7.52316384526264e-37, -1.3625471488070085e-107, 3.1863784098542805e-58, -7.3390072795010034e-152, 8.843436600416711e-75])
    push!(CHALLENGING_TEST_CASES, [-5.8450429676618126e48, 5.8460065492172734e48, -8.113644738705419e31, 2.2608070129399887e18, -2.8157486196326394e14, 1.1219163074151121e-16, -3.469446946302116e-18, -7.022781613968278e-33, -4.747783872879899e-66, 4.770886638840686e-49, 0.0, 1.0258646392213708e-143])
    push!(CHALLENGING_TEST_CASES, [4.9039857307027906e55, -4.903985730913568e55, 4.253529790128084e38, -6.113929544736444e35, -4.5034318682843764e21, 9.880897582450868e18, -0.015610707863335627, 31.99567760992795, 2.4694404437913737e-19, -3.884407479561161e-31, 0.0, 3.421150248200829e-49])
    push!(CHALLENGING_TEST_CASES, [1.6890695450677084e153, 7.991676387146981e146, 1.482750997563031e137, -6.786136153213176e128, -1.0328999512347634e121, -3.6161147844301416e75, -1.0055204626445875e59, -2.0086725506547537e59, 2.1587165974670207e-78, -1.7591402557695623e13, 3.965547829932354e-118, 0.0005096517270430923])
    push!(CHALLENGING_TEST_CASES, [-1.7131586256661423e72, 7.0963014983904605e131, -8.581975028848978e55, 4.970176262751476e71, 1.4349039799653346e-42, -1.2259964326927111e55, 2.963703429627172e-59, -2.4651926818524904e-32, 8.397345250347872e-140, -1.8756126353071983e-48, 0.0, -1.2615557724292182e-88])
    push!(CHALLENGING_TEST_CASES, [-2.2934085264648572e105, 7.662477704330125e53, 1.8268701321259328e47, -3.9999999997671694, 4.000000025181322, 2.318253839861847e-69, 3.308722450212111e-24, -3.66236819963998e-86, 6.223016009052053e-61, 8.598933427792642e-137, 3.754709219460983e-77, -2.231483077492015e-157])
    push!(CHALLENGING_TEST_CASES, [7.268830869260975e134, -7.567984355838164e128, 4.034771612999743e118, -2.701763385431222e112, -4.4794894843556084e102, -1.8956205169862423e66, -5.142201741759719e61, 1.8707220957835557e50, -4.2535294062309093e37, 2.8698592060339836e-42, 1.5469344000339963e-33, 1.1389013994953974e-114])
    push!(CHALLENGING_TEST_CASES, [8.542597691566235e92, 1.2748812982241228e89, -1.9255872307545673e72, 2.1062458333711437e65, 7.136235060706129e44, -7.136238463607684e44, -3.022314549036573e23, -3.8537406796980685e-34, 3.851859904481815e-34, -3.3326034978962064e-50, 1.5127312318830528e-123, -4.616489294221057e-128])
    push!(CHALLENGING_TEST_CASES, [3.3087224742512516e-24, -3.308722449280156e-24, -5.526837209904486e-76, -1.836556182975636e-40, 1.7510038317524695e-92, -6.372741314331202e-58, -1.7024811600192628e-108, -2.749756067942071e-74, 0.0, 1.2814967671991849e-124, 0.0, -7.820637090558988e-149])
    push!(CHALLENGING_TEST_CASES, [1.9426687257745454e84, -1.942668893460852e84, 8.087984000146418e67, 7.577800131701873e50, 4.6768040044786145e49, -7.043594533926744e34, -2.130303774911788e12, 3.2876277279804614e17, -1.823136384158445e-12, 0.0, 0.0, 0.0])
    push!(CHALLENGING_TEST_CASES, [-3.04858256865977e141, 2.3257419570482308e136, -1.1415705357119094e125, 9.683437042825907e119, 2.3485426527695553e108, -3.5835915863256007e103, -1.5541351137805833e85, 9.946464714299745e86, 2.8795390559456074e67, -1.645504562011106e63, 3.4211388289163574e-49, 1.1933345279948005e-153])
    push!(CHALLENGING_TEST_CASES, [2.7266419333252766e135, 2.122174590768711e124, -1.613906173804318e119, 3.821228504629552e106, -6.058242935404445e82, -3.108270227750561e85, 2.280444737288667e18, -1.882849922720344e69, 5.0130492731948986e-124, -1.6556249081225174e53, 0.0, -5.004952893204565e27])
    push!(CHALLENGING_TEST_CASES, [2.0173827172555676e118, -2.0173827172556155e118, -2.1987993225028888e102, 1.1579208923683571e77, 3.1223136528053913e85, -7.307559834712164e47, 1.3451903335895015e66, -9.903539203748971e27, -3.7191331880257895e49, 9.954626220644682e-60, 2.361183393717183e21, -6.81273574113045e-108])
    push!(CHALLENGING_TEST_CASES, [1.4885656537551988e138, -1.4885657726884276e138, -3.940200619639448e115, -1.630045235542361e122, 1.9455449246229203e53, -5.986247397113973e51, -2.1267647932558654e37, -2.4378426377476622e35, 4.4198755240078785e-75, 6.212914221415517e-8, -1.8722508511941427e-96, -2.2413565299567844e-44])
    push!(CHALLENGING_TEST_CASES, [-1.3996208380299954e101, 2.135987036021929e96, 7.770675568902916e84, 5.244880126003687e62, 6.582018239868621e63, 5.7033804689873985e45, -5.709135701121441e45, -1.4731486467496025e29, -5.629818184325194e14, -3.6066322713129513e-130, -0.04687500000011369, 1.3627460130299037e-146])
    push!(CHALLENGING_TEST_CASES, [-7.098034416432836e131, -8.664592794327296e127, 6.622890083400655e110, -7.043778615062339e109, 1.0951105408986678e94, 9.940417272784318e92, -9.033818368295588e77, -2.861519141515292e75, 8.03470093727067e59, 3.138550869154841e57, -2.7222589353675077e40, 0.0])
    push!(CHALLENGING_TEST_CASES, [512.0000000000001, -5.17319204425835e-26, 5.421677776800855e-20, 2.9673196407673584e-67, -1.1479437019748901e-41, 4.118203264146354e-84, -2.967364920550126e-67, -2.0102715910932976e-100, -2.340869468706054e-83, 4.436441297651379e-117, 2.363642526196142e-125, 0.0])
    push!(CHALLENGING_TEST_CASES, [-8.295078549786054e144, -1.2487089169052563e145, -8.627880437845516e68, 1.3863348470604074e129, 4.7531721254038915e52, 4.733781143403508e108, -1.9999999539286362, 8.636348548176395e68, 3.982749991734139e-59, 1.525878906240417e-5, 2.993786554381513e-132, -1.6867516709173627e-80])
    push!(CHALLENGING_TEST_CASES, [-1.7254365864315509e69, 1.7254365866976408e69, 5.378326025377765e51, 2.6544173832867822e42, 4.1538374867752073e34, -5.159547648658637e16, -2.882026736126525e17, -0.0009765166116775752, -1.4901161193847676e-8, -3.3431409185125593e-20, 1.0947644252495471e-47, -1.5046327310166485e-36])
    push!(CHALLENGING_TEST_CASES, [-1.5004241091586868e51, 2.394524282615746e52, 1.0134424700323915e31, -6.084722880977446e31, 6.665789243392e13, 2.9259593875448456e14, 0.0006662838836900775, -0.0031585693359375, 5.585071797169746e-21, 1.0340360082546164e-25, 1.6458068855214e-37, 4.59708060166738e-128])
    push!(CHALLENGING_TEST_CASES, [-2.4866770811613857e86, -3.5455643594412225e44, -3.590542351834114e44, 3.3085173463767532e-24, 3.9614081257118513e28, -1.7862623029309797e-40, -3.308722844658998e-24, -2.4401998202897614e-66, 3.6734198463196485e-40, 3.6931914367956366e-127, -5.280052497822894e-82, 0.0])
    push!(CHALLENGING_TEST_CASES, [1.2024537983431186e111, 4.091749879279161e149, -5.169737632316195e-26, -1.2023070184763433e111, -1.2135025748167865e-42, 3.334220486064287e94, 4.909089451786798e-91, -3.824769919447352e-6, 1.2890452430255343e-129, 5.121665871008023e-26, 0.0, 1.0496676552042055e-140])
    push!(CHALLENGING_TEST_CASES, [0.015624999999886202, -0.015625037260178942, -1.8041801776514132e-19, 8.44839057249404e-19, 1.87841411276311e-37, -1.316549081146154e-35, 7.20126668415841e-54, 2.3969811726055118e-94, 5.34285065650776e-70, 8.1214719682888e-115, 3.2172234934173923e-86, -6.879105134148699e-136])
    push!(CHALLENGING_TEST_CASES, [-1.5577320668298514e124, 2.1153788479208247e124, -1.1742712913869166e108, 9.578270389918748e52, -9.578097130408977e52, -1.2941799919898058e36, -3.790376706332469e35, 5.2202435719679537e-54, -1.8446744073709552e19, 2.9833362911868938e-154, 5.293955920287533e-23, 0.0])
    push!(CHALLENGING_TEST_CASES, [-6.67495948744711e94, 3.112277930720177e85, -8.507053494245878e38, 1.3613084764439114e39, 7.555786372591432e22, 1.5111572745182865e23, 1.1473680794686282e-97, 8.23609214316106e-84, -4.5750367151735614e-114, 4.714822989039384e-100, 0.0, 0.0])
    push!(CHALLENGING_TEST_CASES, [7.621456458934582e140, 1.9979113297630534e146, -5.265392805577171e64, 1.6923032801030364e125, -7.762035730844119e-62, 1.316379626747854e64, -5.714939776406993e-101, 2.6586669666340775e44, 6.19576897286526e-120, -4.257959715155787e-109, 4.1986725672294305e-140, 0.0])
    push!(CHALLENGING_TEST_CASES, [-1.860707134196747e137, 1.860707562065176e137, -1.5130333496020082e118, 4.422775902128218e71, -5.599362022318498e101, 2.765722314458803e54, -1.0411487388925415e85, 5.249931353664564e37, 8.627182933488205e68, -2.649116387534889e-116, 2.807063302309623e-45, 0.0])
    push!(CHALLENGING_TEST_CASES, [-7.695704358302666e112, 2.8147497863775994e14, 7.20038600313765e14, -2.138217397405051e-50, -0.0625, 2.3738919364399497e-66, -4.03896783665483e-28, 1.2392361721172138e-119, -2.0861430890894323e-50, -9.458769559454461e-136, 0.0, 7.636691763614569e-152])
end


const PASSING_NETWORKS = Vector{Tuple{Int,Int}}[]
const OVERLAP_THRESHOLD = parse(Int, ARGS[2])
const ACCURACY_THRESHOLD = parse(Int, ARGS[3])
@assert OVERLAP_THRESHOLD >= IDEAL_OVERLAP_SCORE
@assert ACCURACY_THRESHOLD <= IDEAL_ACCURACY_SCORE


function screen_sum_network(network::AbstractVector{Tuple{Int,Int}})
    v = Vector{Float64}(undef, NUM_TERMS)
    for test_case in CHALLENGING_TEST_CASES
        copy!(v, test_case)
        overlap_score, accuracy_score = test_sum_network!(v, network)
        if overlap_score > OVERLAP_THRESHOLD
            return false
        end
        if accuracy_score < ACCURACY_THRESHOLD
            return false
        end
    end
    return true
end


function random_pair()
    i = rand(1:NUM_TERMS)
    j = rand(1:NUM_TERMS)
    while i == j
        j = rand(1:NUM_TERMS)
    end
    return minmax(i, j)
end


function build_random_network()
    network = Tuple{Int,Int}[]
    while !screen_sum_network(network)
        push!(network, random_pair())
    end
    return network
end


function prune_network!(network::AbstractVector{Tuple{Int,Int}})
    while true
        indices = shuffle(1:length(network))
        pruned = false
        for i in indices
            new_network = deleteat!(copy(network), i)
            if screen_sum_network(new_network)
                deleteat!(network, i)
                pruned = true
                break
            end
        end
        if !pruned
            return network
        end
    end
end


function canonize_network!(network::AbstractVector{Tuple{Int,Int}})
    Base.require_one_based_indexing(network)
    while true
        changed = false
        for i = 1:length(network)-1
            (a, b) = network[i]
            (c, d) = network[i+1]
            if (a != c) & (a != d) & (b != c) & (b != d) & ((a, b) > (c, d))
                network[i], network[i+1] = (c, d), (a, b)
                changed = true
            end
        end
        if !changed
            return network
        end
    end
end


function main()
    network = prune_network!(build_random_network())
    println("Candidate network: ", network)
    flush(stdout)
    start = time_ns()
    overlap_score, accuracy_score, v_overlap, v_accuracy, num_tests =
        parallel_evaluate_sum_network(network, UInt64(1_000_000_000))
    stop = time_ns()
    elapsed = (stop - start) / 1.0e9
    println("Performed ", num_tests, " tests in ", elapsed,
        " seconds (", num_tests / elapsed, " tests per second).")
    println("Scores: ", (overlap_score, accuracy_score))
    if overlap_score > OVERLAP_THRESHOLD
        @assert !isempty(v_overlap)
        println("Adding new overlap test case: ", v_overlap)
        push!(CHALLENGING_TEST_CASES, v_overlap)
    end
    if accuracy_score < ACCURACY_THRESHOLD
        @assert !isempty(v_accuracy)
        println("Adding new accuracy test case: ", v_accuracy)
        push!(CHALLENGING_TEST_CASES, v_accuracy)
    end
    if ((overlap_score <= OVERLAP_THRESHOLD) &
        (accuracy_score >= ACCURACY_THRESHOLD))
        println("Candidate network passed final testing.")
        canonize_network!(network)
        println("Final network: ", network)
        if !(network in PASSING_NETWORKS)
            push!(PASSING_NETWORKS, network)
            sort!(PASSING_NETWORKS)
        end
    else
        println("Candidate network failed final testing.")
    end
    println()
    flush(stdout)

    failures = (!).(screen_sum_network.(PASSING_NETWORKS))
    if any(failures)
        println("New test cases eliminated ", sum(failures), " networks.")
        deleteat!(PASSING_NETWORKS, failures)
        sort!(PASSING_NETWORKS)
    end
    println.(PASSING_NETWORKS)
    println()
    flush(stdout)
end


while true
    main()
end
